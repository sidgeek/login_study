# 用户登录与第三方登录系统设计

本文档描述了支持本地账号登录（用户名/密码、手机号）及第三方登录（GitHub, WeChat 等）的数据库表结构设计与流程。

## 1. 设计原则

采用 **Account (用户主表)** + **AuthIdentity (认证授权表)** 的分离设计模式。

*   **User (用户主表)**：存储用户的核心业务身份信息（ID、昵称、头像），不包含具体的验证凭据（如密码）。
*   **AuthIdentity (认证授权表)**：存储具体的登录凭证。每种登录方式（密码、手机号、第三方）对应一条记录，统一关联到 User 表。

这种设计使得一个用户可以同时绑定手机号、邮箱、GitHub 等多种登录方式，且易于扩展。

## 2. 数据库表结构

### 2.1 用户主表 (users)

用于存储用户在系统中的唯一身份标识及基本画像。

| 字段名 | 类型 | 必填 | 默认值 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| `id` | BigInt / UUID | Y | - | 用户全局唯一标识 (PK) |
| `nickname` | Varchar(64) | N | - | 用户昵称 |
| `avatar` | Varchar(255) | N | - | 用户头像 URL |
| `created_at` | DateTime | Y | Now() | 注册时间 |
| `updated_at` | DateTime | Y | Now() | 更新时间 |
| `status` | TinyInt | Y | 1 | 状态：1-正常, 0-禁用 |

### 2.2 认证授权表 (auth_identities)

用于存储用户的登录凭证。一个 `user_id` 可以对应多条 `auth_identities` 记录。

| 字段名 | 类型 | 必填 | 默认值 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| `id` | BigInt / UUID | Y | - | 主键 (PK) |
| `user_id` | BigInt / UUID | Y | - | 关联用户主表 ID (FK) |
| `identity_type` | Varchar(20) | Y | - | 认证类型：`password`, `phone`, `github`, `google`, `wechat` |
| `identifier` | Varchar(255) | Y | - | 标识符：用户名、手机号、邮箱、OpenID |
| `credential` | Varchar(255) | N | - | 凭证：密码哈希 (Hash)、第三方 AccessToken (可选) |
| `data` | JSON | N | - | 额外数据：第三方返回的原始 UserInfo、Token 过期时间等 |
| `created_at` | DateTime | Y | Now() | 绑定时间 |
| `last_login_at`| DateTime | N | - | 最后登录时间 |

#### 索引设计
*   `idx_user_id`: (user_id) —— 用于查询某用户的所有绑定方式。
*   `uk_type_identifier`: (identity_type, identifier) —— 唯一索引，确保同一种类型的标识符全局唯一（例如手机号不能重复注册）。

## 3. 示例数据

**场景 1：用户使用手机号注册**

**users 表**
```json
{ "id": 1001, "nickname": "用户_8821", "avatar": "default.png" }
```

**auth_identities 表**
```json
{
  "id": 1,
  "user_id": 1001,
  "identity_type": "phone",
  "identifier": "13800138000",
  "credential": "bcrypt_hash_xxxxxx" 
}
```

**场景 2：用户绑定 GitHub**

**auth_identities 表** (新增一条记录)
```json
{
  "id": 2,
  "user_id": 1001,
  "identity_type": "github",
  "identifier": "github_user_id_123456", // GitHub 的唯一 ID
  "credential": "gh_access_token_xxxx", // 可选存储
  "data": { "login": "sidgeek", "html_url": "..." }
}
```

## 4. 登录/注册流程逻辑

### 4.1 本地登录 (手机号/密码)
1.  前端提交 `type='phone'`, `identifier='138...'`, `password='...'`。
2.  后端查询 `auth_identities` 表，匹配 `identity_type` 和 `identifier`。
3.  如果存在，验证 `credential` (密码哈希)。
4.  验证通过，获取 `user_id`，签发 JWT。

### 4.2 第三方登录 (OAuth2)
1.  前端引导用户跳转第三方授权页。
2.  回调获取第三方的 `code`，后端换取 `access_token` 和用户信息 (OpenID)。
3.  后端查询 `auth_identities` 表：
    *   **已存在** (`identity_type='github'` && `identifier=OpenID`)：直接获取关联的 `user_id`，登录成功。
    *   **不存在**：
        *   **创建新账号**：在 `users` 表创建新用户 -> 在 `auth_identities` 表插入 GitHub 记录 -> 登录成功。
        *   **绑定已有账号** (如果已登录)：直接在 `auth_identities` 表插入记录关联当前 `user_id`。

## 5. 扩展性

*   **邮箱登录**：新增 `identity_type='email'`, `identifier='test@example.com'`。
*   **微信登录**：新增 `identity_type='wechat'`, `identifier='微信OpenID'`。
*   **解绑**：删除 `auth_identities` 表中对应记录（需校验是否为唯一登录方式）。
